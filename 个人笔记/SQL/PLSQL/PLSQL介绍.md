> SQL 非过程化语言，某些情况下满足不了复杂业务流程的需求
> PL/SQL（过程化语言）可以实现复杂的业务逻辑；在SQL上拓展而成的，可以像Java一样实现逻辑判断/条件循环以及异常处理等

##### PL/SQL 特点

- 支持事务控制和SQL数据操作命令；
- 支持SQL的所有数据类型，并在此基础上扩展了新的数据类型，也支持SQL的函数以及运算符；
- 可以存储在Oracle服务器中；
- 服务器上的PL/SQL程序可以使用权限进行控制；
- Oracle有自己的DBMS包，可以处理数据的控制和定义命令

---

##### PL/SQL 优势

- 提高程序的运行性能
  - 执行SQL时，只能一条一条的像Oracle服务器发送；加入业务逻辑需要几十条SQL语句，那么在执行过程中，客户端会几十次的连接数据库服务器，当业务被完成时，会浪费大量的资源在网络连接上
  - 执行PL/SQL语句，PL/SQL的语句块可以包含多条SQL语句，语句块可以嵌入到程序里，用户只需要连接一次数据库就可以把需要的参数传递过去，其他的部分在Oracle服务器内部执行完成，最终返回结果

- 可以使程序模块化
  - 在程序块中实现一个或多个功能；使用块可以把对于多张表的操作都放到一个块内，对外只需要提供一个调用方式和需要传入的参数
- 可以采用逻辑控制语句来控制程序结构
  - PL/SQL 可以利用条件或循环语句来控制流程
- 利用处理运行时的错误信息
  - 标准的 SQL 在遇到错误时会提示异常，例如增加数据，一旦有异常就会终止，只会判断程序本身的问题，而不是逻辑上有问题
  - 例如：产品表增加数据时，数量只要求数值型，没有更细的要求，加入增加一个负数，正常可以进入数据库，但在逻辑上是不允许的，因为没有数量为负的产品。PL/SQL可以完全避免类似问题，我们可以利用流程拒绝这部门记录进入数据库
  - 利用PL/SQL还可以处理一些程序上的异常，不至于因终止SQL操作，而造成调用SQL的展示页面出现生硬的错误提示
- 良好的可移植性
  - 可以成功地运行到不同服务器中
    - 从Windows服务器移植到Linux服务器下
    - 从一个Oracle版本移植到其他版本的Oracle中

---

##### PL/SQL 结构

- 由一个块组成，分为三部分 （不论代码量多少，基本结构都是由这三个组成）

```sql
[DECLARE]--声明开始关键字
/*这里是声明部分，包括PL/SQL中的变量、常量以及类型等*/
BEGIN--执行部分开始的标志❗❗必选
/*这里是执行部分，是整个PL/SQL块的主体部分，该部分在PL/SQL块中必须存在，可以是SQL语句或者程序流
程控制语句等*/
[EXCEPTION]--异常开始部分的关键字
/*这里是异常处理部分，当出现异常时程序流程可以进入此处*/
END;--执行结束标志
```

```sql
-- demo 01
begin
    -- 执行体开始
    DBMS_OUTPUT.PUT_LINE('这是执行体部分......'); -- 输出这句话到屏幕
end; -- 执行体结束

-- demo 02
declare -- 声明变量的关键字
    result number(8, 2); -- 声明一个变量 result ,数据类型是 number
begin
    -- 执行体开始
    result := 100 / 6; -- 给变量赋值
    DBMS_OUTPUT.PUT_LINE('最后的结果是：' || result); -- 输出结果
end; -- 结束

-- demo 03
declare
    v_product_id varchar2(12);
begin
    select PRODUCT_ID
    into v_product_id -- select 。。。 into ... PL/SQL 特有的赋值语句（select 后的列名顺序要和 into 后的列名顺序一一对应）
    from products
    where PRODUCTS.PRODUCT_NAME = 'Intel Xeon E5-2697 V3'; -- 将数据存入到 v_product中
    DBMS_OUTPUT.PUT_LINE('产品对应的编码是' || v_product_id);
exception
    -- 该类型语句只能返回一条数据，超过一条则会触发异常
    when no_data_found then
        DBMS_OUTPUT.put_line('没有对应的编码'); -- 找不到数据触发此信息
    when too_many_rows then
        DBMS_OUTPUT.put_line('对应数据过多，请确认'); -- 返回记录过多触发此信息
end ;
```

---

##### PL/SQL 规则



- 允许出现的字符集
  - 字母，包括大写和小写。
  - 数字，即0～9。
  - 空格、回车符以及制表符。
  - 符号包括+、-、*、/、＜、＞、=、!、～、^、;、:、.、'、@、%、,、"、#、$、＆、_、|、(、)、[、]、{、}、?。
- 必须遵守的要求
  - 不区分大小写，TEST = test ；但是注意，所有字符在存储时都会被修改为大写
  - 标识符：字母/数字/下划线 组成；字母开头；不超过30个字符
  - 不能使用保留字，如果和保留字同名用双引号括起来
  - 语句以分号结束，END后面需要使用分号
  - 语句的关键字/标识符/字段等都需要空格分隔
  - 字符类型和日期类型需要使用单引号
- 提高代码可读性的要求
  - 每行写一条语句
  - 保留字/Oracle内置函数/程序包以及用户定义的数据类型用大写
  - 所有的过程名称用大写
  - 变量前面最好加上前缀，表明变量的数据类型，作用范围等
  - 变量和程序段处的注释都要加好

---

##### PL/SQL 注释

单行注释：  --

多行注释： /*  */
